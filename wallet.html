<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CreatorHub Wallet</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>

:root{
--bg:#ffffff;
--text:#111827;
--card:#f3f4f6;
--accent:#22c55e;
}

@media(prefers-color-scheme:dark){
:root{
--bg:#020617;
--text:#ffffff;
--card:#111827;
}
}

body{
margin:0;
font-family:Arial;
background:var(--bg);
color:var(--text);
}

.topbar{
display:flex;
align-items:center;
padding:14px;
background:var(--bg);
box-shadow:0 5px 20px rgba(0,0,0,.3);
position:sticky;
top:0;
}

.back{
font-size:22px;
cursor:pointer;
width:40px;
}

.pageTitle{
flex:1;
text-align:center;
font-size:18px;
font-weight:bold;
color:var(--accent);
}

.container{
padding:18px;
}

.card{
background:var(--card);
padding:18px;
border-radius:16px;
margin-bottom:18px;
box-shadow:0 8px 25px rgba(0,0,0,.2);
}

.balance{
font-size:34px;
font-weight:bold;
color:var(--accent);
margin-top:10px;
}

input{
width:100%;
padding:14px;
margin-top:12px;
border:none;
border-radius:10px;
background:rgba(0,0,0,.05);
color:var(--text);
outline:none;
}

button{
width:100%;
padding:14px;
margin-top:15px;
border:none;
background:linear-gradient(90deg,#22c55e,#4ade80);
border-radius:12px;
font-weight:bold;
color:white;
cursor:pointer;
}

.item{
background:rgba(0,0,0,.05);
padding:12px;
border-radius:10px;
margin-top:8px;
display:flex;
justify-content:space-between;
font-size:14px;
}

canvas{
background:rgba(0,0,0,.05);
border-radius:10px;
padding:10px;
}

</style>

</head>

<body>

<div class="topbar">
<div class="back" onclick="history.back()">â¬…</div>
<div class="pageTitle">ðŸ’° Creator Wallet</div>
</div>

<div class="container">

<div class="card">
<h3>Available Balance</h3>
â‚¹ <span id="balance" class="balance">0</span>
</div>

<div class="card">
<h3>Withdraw Money (20% Platform Fee)</h3>
<input id="upi" placeholder="Enter UPI ID">
<input id="amount" placeholder="Withdraw Amount â‚¹" type="number">
<button onclick="withdraw()">Withdraw Request ðŸš€</button>
</div>

<div class="card">
<h3>ðŸ“Š Earnings Chart</h3>
<canvas id="chart"></canvas>
</div>

<div class="card">
<h3>ðŸ“œ Transaction History</h3>
<div id="history">Loading...</div>
</div>

</div>

<script>

const API="https://script.google.com/macros/s/AKfycbzgKPuIAmuZWOfilOj8gM9qJcZesz3ECPIhpCvBmupKFY2t76_ObVWyylnoTa4ecyda/exec";
const ADMIN="ayushprajpati6@gmail.com";
const ADMIN_NUMBER="918543936339";

let user=JSON.parse(localStorage.getItem("user"));

if(!user){
alert("Login First");
location.href="login.html";
}

/* DB */

async function getDB(db){
try{
let r=await fetch(API+"?db="+db+"&t="+Date.now());
return await r.json();
}catch{
return [];
}
}

async function saveDB(db,data){
await fetch(API,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({db,data})
});
}

let balance=0;
let chartInstance=null;

/* LOAD WALLET */

async function loadWallet(){

let wallets=await getDB("wallet")||[];
let myWallet=wallets.find(w=>w.email===user.email);

balance=myWallet?myWallet.balance:0;
document.getElementById("balance").innerText=balance;

let orders=await getDB("orders")||[];
let historyBox=document.getElementById("history");

let earnings=[];

if(user.email!==ADMIN){

let myOrders=orders.filter(o=>o.seller===user.email);

if(!myOrders.length){
historyBox.innerHTML="No Earnings Yet";
}else{
historyBox.innerHTML="";
myOrders.reverse().forEach(o=>{
let earn=Math.floor(o.amount*0.8);
earnings.push(earn);
historyBox.innerHTML+=`
<div class="item">
<div>â‚¹ ${earn}</div>
<div>Sale</div>
</div>`;
});
}

}else{

if(!orders.length){
historyBox.innerHTML="No Earnings Yet";
}else{
historyBox.innerHTML="";
orders.reverse().forEach(o=>{
let earn=o.amount-Math.floor(o.amount*0.8);
earnings.push(earn);
historyBox.innerHTML+=`
<div class="item">
<div>â‚¹ ${earn}</div>
<div>Commission</div>
</div>`;
});
}

}

/* CHART SAFE */

if(chartInstance){
chartInstance.destroy();
}

chartInstance=new Chart(document.getElementById("chart"),{
type:"line",
data:{
labels:earnings.map((_,i)=>"Tx "+(i+1)),
datasets:[{
data:earnings,
borderWidth:2,
tension:.3
}]
},
options:{
responsive:true,
plugins:{legend:{display:false}}
}
});

}

loadWallet();

/* WITHDRAW FINAL */

async function withdraw(){

let amount=Number(document.getElementById("amount").value);
let upi=document.getElementById("upi").value.trim();

if(!amount||!upi){
alert("Fill Details");
return;
}

if(amount<=0){
alert("Invalid Amount");
return;
}

if(balance<amount){
alert("Low Balance");
return;
}

/* COMMISSION */

let sellerAmount=Math.floor(amount*0.8);
let adminCommission=amount-sellerAmount;

let wallets=await getDB("wallet")||[];
let withdraws=await getDB("withdraw")||[];

let index=wallets.findIndex(w=>w.email===user.email);

if(index===-1){
alert("Wallet Not Found");
return;
}

if(wallets[index].balance<amount){
alert("Balance Changed Reload");
location.reload();
return;
}

/* DEDUCT FULL */

wallets[index].balance-=amount;

withdraws.push({
email:user.email,
requestAmount:amount,
sendAmount:sellerAmount,
adminCommission:adminCommission,
upi:upi,
status:"Pending",
date:new Date().toLocaleString()
});

await saveDB("wallet",wallets);
await saveDB("withdraw",withdraws);

/* WHATSAPP ALERT */

let msg=encodeURIComponent(
"ðŸ”¥ CreatorHub Withdraw Request\n\n"+
"User: "+user.email+"\n"+
"UPI: "+upi+"\n\n"+
"Requested: â‚¹"+amount+"\n"+
"Send To User: â‚¹"+sellerAmount+"\n"+
"Admin Commission: â‚¹"+adminCommission
);

window.open(
"https://wa.me/"+ADMIN_NUMBER+"?text="+msg,
"_blank"
);

alert("Withdraw Request Sent âœ…");
location.reload();

}

</script>

</body>
</html>
