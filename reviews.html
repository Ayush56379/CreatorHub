<!DOCTYPE html>
<html>

<head>

<meta name="viewport"
content="width=device-width,initial-scale=1">

<title>Reviews</title>

<style>

body{
margin:0;
font-family:Arial;
background:#111;
color:white;
}

.header{
display:flex;
align-items:center;
justify-content:space-between;
background:#000;
padding:12px;
}

.backBtn{
background:#2563eb;
border:none;
color:white;
padding:8px 12px;
border-radius:8px;
cursor:pointer;
}

.dashBtn{
background:#f59e0b;
padding:8px 14px;
border-radius:8px;
color:white;
text-decoration:none;
}

.container{
padding:20px;
}

.card{
background:#1f2937;
padding:20px;
border-radius:12px;
}

textarea{
width:100%;
height:120px;
border:none;
border-radius:10px;
margin-top:10px;
padding:10px;
}

.submitBtn{
width:100%;
padding:14px;
margin-top:10px;
border:none;
background:orange;
border-radius:10px;
cursor:pointer;
}

.review{
background:#111;
padding:10px;
border-radius:8px;
margin-top:10px;
}

</style>

</head>

<body>

<div class="header">

<button class="backBtn"
onclick="history.back()">

⬅

</button>

⭐ Reviews

<a href="dashboard.html"
class="dashBtn">

Dashboard

</a>

</div>



<div class="container">

<div class="card">

<h2>Leave Review ⭐</h2>

<textarea id="reviewText"
placeholder="Write Review">

</textarea>

<button class="submitBtn"
onclick="submitReview()">

Submit Review

</button>

<h3>My Reviews</h3>

<div id="reviewList">

Loading...

</div>

</div>

</div>


<script>

const API=
"https://script.google.com/macros/s/AKfycbzgKPuIAmuZWOfilOj8gM9qJcZesz3ECPIhpCvBmupKFY2t76_ObVWyylnoTa4ecyda/exec";


let user=
JSON.parse(localStorage.getItem("user"));

if(!user){

alert("Login First");

location.href="login.html";

}


/* PRODUCT VERIFY */

let reviewProduct=
localStorage.getItem("reviewProduct");

if(!reviewProduct){

alert("Purchase First");

location.href="products.html";

}


/* DB */

async function getDB(db){

let r=
await fetch(API+"?db="+db+"&t="+Date.now());

return await r.json();

}

async function saveDB(db,data){

await fetch(API,{

method:"POST",

headers:{
"Content-Type":"application/json"
},

body:JSON.stringify({

db:db,
data:data

})

});

}


/* PURCHASE VERIFY */

async function submitReview(){

let text=
document.getElementById(
"reviewText"
).value.trim();

if(!text){

alert("Write Review");

return;

}


/* CHECK PURCHASE */

let orders=
await getDB("orders")||[];

let purchased=
orders.find(o=>

o.buyer===user.email &&

String(o.product)===String(reviewProduct)

);

if(!purchased){

alert(
"Only Buyers Can Review"
);

return;

}


/* SAVE REVIEW */

let reviews=
await getDB("reviews")||[];


/* DUPLICATE STOP */

let already=
reviews.find(r=>

r.user===user.email &&

String(r.product)===String(reviewProduct)

);

if(already){

alert(
"You Already Reviewed"
);

return;

}


reviews.push({

user:user.email,

product:reviewProduct,

message:text,

date:new Date()
.toLocaleString()

});


await saveDB(
"reviews",
reviews
);

alert(
"Review Submitted ✅"
);

document.getElementById(
"reviewText"
).value="";

loadReviews();

}


/* LOAD */

async function loadReviews(){

let reviews=
await getDB("reviews")||[];

let my=
reviews.filter(r=>

r.user===user.email

&&

String(r.product)===String(reviewProduct)

);

let box=
document.getElementById("reviewList");

if(!my.length){

box.innerHTML=
"No Reviews Yet";

return;

}

box.innerHTML="";

my.forEach(r=>{

box.innerHTML+=`

<div class="review">

${r.message}

<br>

<small>

${r.date}

</small>

</div>

`;

});

}

loadReviews();

</script>

</body>

</html>
