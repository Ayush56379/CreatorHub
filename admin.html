<script>

const ADMIN="ayushprajpati6@gmail.com";

const API="https://script.google.com/macros/s/AKfycbzgKPuIAmuZWOfilOj8gM9qJcZesz3ECPIhpCvBmupKFY2t76_ObVWyylnoTa4ecyda/exec";


let user=JSON.parse(localStorage.getItem("user"));

if(!user || user.email!==ADMIN){

alert("Admin Only");

location.href="index.html";

}


/* SAFE GET DB */

async function getDB(db){

try{

let res=await fetch(API+"?db="+db+"&t="+Date.now());

let text=await res.text();

return JSON.parse(text);

}catch(e){

console.log("DB ERROR :",db,e);

return [];

}

}


/* SAFE SAVE */

async function saveDB(db,data){

try{

await fetch(API,{

method:"POST",

headers:{

"Content-Type":"application/json"

},

body:JSON.stringify({db,data})

});

}catch(e){

alert("Save Failed ❌");

}

}



let editID=null;


/* PRODUCTS */

async function loadProducts(){

let products=await getDB("products");

let box=document.getElementById("products");

box.innerHTML="";


products.reverse().forEach(p=>{

box.innerHTML+=`

<div class="row">

<b>${p.title}</b>

<br>

₹${p.price}

<br>

Seller :

${p.owner}

<br>

Status :

${p.status}

<br>

<button class="edit"

onclick="openEdit('${p.id}')">

Edit

</button>

<button class="delete"

onclick="deleteProduct('${p.id}')">

Delete

</button>

<button class="approve"

onclick="approve('${p.id}')">

Approve

</button>

<button class="reject"

onclick="reject('${p.id}')">

Reject

</button>

</div>

`;

});

}



/* OPEN EDIT */

async function openEdit(id){

editID=id;

let products=await getDB("products");

let p=products.find(x=>String(x.id)===String(id));

if(!p){

alert("Product Missing");

return;

}

eTitle.value=p.title||"";

ePrice.value=p.price||"";

eSeller.value=p.owner||"";

editBox.style.display="block";

}



function closeEdit(){

editBox.style.display="none";

}



/* SAVE EDIT */

async function saveEdit(){

let products=await getDB("products");

products=products.map(p=>{

if(String(p.id)===String(editID)){

p.title=eTitle.value;

p.price=Number(ePrice.value);

p.owner=eSeller.value;

}

return p;

});

await saveDB("products",products);

alert("Saved ✅");

closeEdit();

loadProducts();

}



/* DELETE */

async function deleteProduct(id){

if(!confirm("Delete Ebook?"))return;

let products=await getDB("products");

products=products.filter(p=>String(p.id)!==String(id));

await saveDB("products",products);

loadProducts();

}



async function deleteEdit(){

deleteProduct(editID);

closeEdit();

}



/* APPROVE */

async function approve(id){

let products=await getDB("products");

products.forEach(p=>{

if(String(p.id)===String(id)){

p.status="approved";

}

});

await saveDB("products",products);

loadProducts();

}



async function reject(id){

deleteProduct(id);

}



/* WALLET */

async function loadWallets(){

let wallets=await getDB("wallet");

let box=document.getElementById("wallets");

box.innerHTML="";


wallets.forEach(w=>{

box.innerHTML+=`

<div class="row">

User :

${w.email}

<br>

Balance ₹${w.balance||0}

</div>

`;

});

}



/* SELLERS */

async function loadSellers(){

let users=await getDB("users");

let box=document.getElementById("sellers");

box.innerHTML="";


users.forEach(u=>{

box.innerHTML+=`

<div class="row">

${u.email}

${u.banned?" (BANNED)":""}

<button class="ban"

onclick="ban('${u.email}')">

Ban

</button>

</div>

`;

});

}



async function ban(email){

let users=await getDB("users");

users.forEach(u=>{

if(u.email===email){

u.banned=true;

}

});

await saveDB("users",users);

alert("User Banned");

loadSellers();

}



/* WITHDRAW */

async function loadWithdraw(){

let withdraw=await getDB("withdraw");

let box=document.getElementById("withdraws");

box.innerHTML="";


withdraw.forEach(w=>{

if(w.status==="Approved")return;

box.innerHTML+=`

<div class="row">

${w.email}

₹${w.requestAmount}

<button class="approve"

onclick="approveWithdraw('${w.date}')">

Approve

</button>

</div>

`;

});

}



async function approveWithdraw(date){

let withdraw=await getDB("withdraw");

withdraw.forEach(w=>{

if(w.date===date){

w.status="Approved";

}

});

await saveDB("withdraw",withdraw);

alert("Withdraw Approved");

loadWithdraw();

}



/* PROFIT */

async function profit(){

let orders=await getDB("orders");

let total=0;

orders.forEach(o=>{

total+=o.amount*.20;

});

profit.innerText=Math.floor(total);

}



/* LOAD */

loadProducts();

loadWallets();

loadSellers();

loadWithdraw();

profit();

</script>
