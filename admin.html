<script>

const ADMIN="ayushprajpati6@gmail.com";
const API="YOUR_GOOGLE_SCRIPT_URL";

let user=JSON.parse(localStorage.getItem("user"));

if(!user || user.email!==ADMIN){
alert("Admin Only");
location.href="index.html";
}

/* ================= DB ================= */

async function getDB(db){
try{
let r=await fetch(API+"?db="+db+"&t="+Date.now());
let data=await r.json();
if(!Array.isArray(data)) return [];
return data;
}catch(e){
console.log("GET ERROR",e);
return [];
}
}

async function saveDB(db,data){
await fetch(API,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({db,data})
});
}

/* ================= PRODUCTS ================= */

async function loadProducts(){
let products=await getDB("products");
let box=document.getElementById("products");
box.innerHTML="";

products.reverse().forEach(p=>{
box.innerHTML+=`
<div class="row">
<div>
<b>${p.title}</b><br>
₹${p.price}<br>
Seller: ${p.owner}
</div>
<div>
<button class="edit" onclick="openEdit('${p.id}')">Edit</button>
<button class="delete" onclick="deleteProduct('${p.id}')">Delete</button>
<button onclick="approveProduct('${p.id}')" style="background:#22c55e">Approve</button>
<button onclick="rejectProduct('${p.id}')" style="background:red">Reject</button>
</div>
</div>`;
});
}

/* ================= USERS ================= */

async function loadUsers(){

let users=await getDB("users");
let wallets=await getDB("wallet");

let box=document.getElementById("wallets");
box.innerHTML="";

users.forEach(u=>{

let w=wallets.find(x=>x.email===u.email);

box.innerHTML+=`
<div class="row">
<div>
<b>${u.email}</b><br>
Wallet: ₹ ${w? w.balance:0}
${u.banned? "<br><span style='color:red'>BANNED</span>":""}
</div>
<div>
<button style="background:red"
onclick="banUser('${u.email}')">
Ban
</button>
</div>
</div>
`;

});
}

/* BAN USER */

async function banUser(email){

let users=await getDB("users");

users=users.map(u=>{
if(u.email===email){
u.banned=true;
}
return u;
});

await saveDB("users",users);

alert("User Banned");
loadUsers();
}

/* ================= WITHDRAW ================= */

async function loadWithdraws(){

let withdraws=await getDB("withdraw");
let box=document.getElementById("withdraws");
box.innerHTML="";

withdraws.reverse().forEach(w=>{

if(w.status==="Approved") return;

box.innerHTML+=`
<div class="row">
<div>
<b>${w.email}</b><br>
₹${w.requestAmount}<br>
UPI: ${w.upi}
</div>
<div>
<button style="background:#22c55e"
onclick="approveWithdraw('${w.date}')">
Approve
</button>
</div>
</div>
`;

});
}

async function approveWithdraw(date){

let withdraws=await getDB("withdraw");

withdraws=withdraws.map(w=>{
if(w.date===date){
w.status="Approved";
}
return w;
});

await saveDB("withdraw",withdraws);

alert("Withdraw Approved");
loadWithdraws();
}

/* ================= PROFIT ================= */

async function loadProfit(){

let orders=await getDB("orders");
let total=0;

orders.forEach(o=>{
total+=o.amount*0.20;
});

document.getElementById("profit").innerText=Math.floor(total);
}

/* ================= INIT ================= */

loadProducts();
loadUsers();
loadWithdraws();
loadProfit();

</script>
