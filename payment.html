<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Buy Ebook</title>

<style>
body{
margin:0;
font-family:Arial;
background:#020617;
color:white;
}

.topbar{
display:flex;
align-items:center;
padding:14px;
box-shadow:0 5px 20px black;
}

.back{
font-size:22px;
cursor:pointer;
width:40px;
}

.title{
flex:1;
text-align:center;
font-weight:bold;
color:#22c55e;
}

.container{
padding:20px;
}

.card{
background:#111827;
padding:20px;
border-radius:16px;
max-width:520px;
margin:auto;
}

.card img{
width:100%;
height:220px;
object-fit:cover;
border-radius:12px;
}

button{
width:100%;
padding:15px;
margin-top:15px;
border:none;
border-radius:10px;
font-weight:bold;
cursor:pointer;
}

.pay{
background:orange;
}

.confirm{
background:linear-gradient(90deg,#22c55e,#4ade80);
color:white;
}
</style>
</head>

<body>

<div class="topbar">
<div class="back" onclick="history.back()">‚¨Ö</div>
<div class="title">CreatorHub</div>
</div>

<div class="container">
<div class="card">

<h2>üí≥ Buy Ebook</h2>

<img id="cover">
<h3 id="title"></h3>
<h2 id="price"></h2>

<button class="pay" onclick="payNow()">
Pay Using UPI üöÄ
</button>

<button id="confirmBtn" class="confirm" onclick="confirmPayment()">
I Have Paid ‚úÖ
</button>

</div>
</div>

<script>

const API="https://script.google.com/macros/s/AKfycbzgKPuIAmuZWOfilOj8gM9qJcZesz3ECPIhpCvBmupKFY2t76_ObVWyylnoTa4ecyda/exec";

const ADMIN_UPI="9429970598@fam";
const ADMIN_EMAIL="ayushprajpati6@gmail.com";

let buyId=localStorage.getItem("buyProduct");
let user=JSON.parse(localStorage.getItem("user"));

if(!user){
alert("Login First");
location.href="login.html";
}

/* DRIVE IMAGE FIX */
function driveImage(link){
if(!link)return"https://picsum.photos/500";
try{
let id="";
if(link.includes("id=")){
id=link.split("id=")[1].split("&")[0];
}
if(link.includes("/file/d/")){
id=link.split("/file/d/")[1].split("/")[0];
}
if(id){
return "https://drive.google.com/thumbnail?id="+id+"&sz=w1000";
}
}catch{}
return link;
}

/* DB FUNCTIONS */
async function getDB(db){
try{
let r=await fetch(API+"?db="+db+"&t="+Date.now());
return await r.json();
}catch{
return [];
}
}

async function saveDB(db,data){
await fetch(API,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({db,data})
});
}

let product=null;

/* LOAD PRODUCT */
async function load(){

let products=await getDB("products");

product=products.find(p=>String(p.id)===String(buyId));

if(!product){
alert("Product Missing");
history.back();
return;
}

/* SELF BUY BLOCK */
if(product.owner===user.email){
alert("You Cannot Buy Your Own Product");
history.back();
return;
}

document.getElementById("cover").src=driveImage(product.image);
document.getElementById("title").innerText=product.title;
document.getElementById("price").innerText="‚Çπ "+product.price;

}

load();

/* OPEN UPI */
function payNow(){
if(!product)return;

let link=`upi://pay?pa=${ADMIN_UPI}&pn=CreatorHub&am=${product.price}&cu=INR`;

window.location.href=link;
}

/* FINAL PAYMENT CONFIRM */
async function confirmPayment(){

if(!product)return;

if(!confirm("Confirm Payment Done?"))return;

let btn=document.getElementById("confirmBtn");
btn.disabled=true;
btn.innerText="Processing...";

try{

let orders=await getDB("orders")||[];

/* DUPLICATE PURCHASE BLOCK */
let already=orders.find(o=>
o.buyer===user.email &&
String(o.product)===String(product.id)
);

if(already){
alert("You Already Purchased This Product");
localStorage.removeItem("buyProduct");
location.href="library.html";
return;
}

/* SAVE ORDER */
orders.push({
buyer:user.email,
product:product.id,
seller:product.owner,
amount:product.price,
date:new Date().toLocaleString()
});

await saveDB("orders",orders);

/* REVIEW UNLOCK */
localStorage.setItem("reviewProduct",product.id);

/* WALLET SYSTEM */
let wallets=await getDB("wallet")||[];

let sellerShare=Math.floor(product.price*0.8);
let adminShare=product.price-sellerShare;

/* SELLER CREDIT */
let sellerWallet=wallets.find(w=>w.email===product.owner);

if(sellerWallet){
sellerWallet.balance=(sellerWallet.balance||0)+sellerShare;
}else{
wallets.push({
email:product.owner,
balance:sellerShare
});
}

/* ADMIN CREDIT */
let adminWallet=wallets.find(w=>w.email===ADMIN_EMAIL);

if(adminWallet){
adminWallet.balance=(adminWallet.balance||0)+adminShare;
}else{
wallets.push({
email:ADMIN_EMAIL,
balance:adminShare
});
}

await saveDB("wallet",wallets);

alert("Payment Successful ‚úÖ\nYou Can Now Leave Review ‚≠ê");

/* Redirect to Review Page */
location.href="review.html";

}catch(e){

console.log(e);
alert("Error Saving Data");

btn.disabled=false;
btn.innerText="I Have Paid ‚úÖ";

}

}

</script>

</body>
</html>
