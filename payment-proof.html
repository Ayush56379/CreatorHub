<!DOCTYPE html>
<html lang="en">

<head>

<meta charset="UTF-8">

<meta name="viewport"
content="width=device-width,initial-scale=1">

<title>Payment Proof</title>

<style>

body{

margin:0;

font-family:Arial;

background:#020617;

color:white;

}

.topbar{

display:flex;

align-items:center;

padding:14px;

box-shadow:0 5px 20px black;

}

.back{

font-size:22px;

cursor:pointer;

width:40px;

}

.title{

flex:1;

text-align:center;

color:#22c55e;

font-weight:bold;

}

.container{

padding:20px;

}

.card{

background:#111827;

padding:20px;

border-radius:15px;

max-width:520px;

margin:auto;

}

img{

width:100%;

height:220px;

object-fit:cover;

border-radius:12px;

}

input{

width:100%;

padding:14px;

margin-top:15px;

border:none;

border-radius:10px;

}

button{

width:100%;

padding:15px;

margin-top:15px;

border:none;

border-radius:10px;

background:

linear-gradient(90deg,#22c55e,#4ade80);

color:white;

font-weight:bold;

cursor:pointer;

}

</style>

</head>

<body>


<div class="topbar">

<div class="back"

onclick="history.back()">

â¬…

</div>

<div class="title">

Upload Payment Proof

</div>

</div>


<div class="container">

<div class="card">

<h2>

ðŸ“¸ Upload Screenshot

</h2>


<img id="cover">


<h3 id="title"></h3>

<h2 id="price"></h2>


<input

type="file"

id="proof"

accept="image/*">


<button

onclick="uploadProof()">

Upload & Complete Purchase ðŸš€

</button>


</div>

</div>


<script>

const API=

"https://script.google.com/macros/s/AKfycbzgKPuIAmuZWOfilOj8gM9qJcZesz3ECPIhpCvBmupKFY2t76_ObVWyylnoTa4ecyda/exec";


const ADMIN_EMAIL=

"ayushprajpati6@gmail.com";


let user=

JSON.parse(

localStorage.getItem("user")

);


if(!user){

location.href="login.html";

}


let buyId=

localStorage.getItem("buyProduct");


/* DRIVE IMAGE FIX */

function driveImage(link){

if(!link)

return"https://picsum.photos/400";

try{

let id="";

if(link.includes("id="))
id=link.split("id=")[1].split("&")[0];

else if(link.includes("/file/d/"))
id=link.split("/file/d/")[1].split("/")[0];

if(id)
return "https://drive.google.com/thumbnail?id="+id+"&sz=w1000";

}catch{}

return link;

}


/* DB */

async function getDB(db){

let r=

await fetch(

API+"?db="+db+"&t="+Date.now()

);

return await r.json();

}


async function saveDB(db,data){

await fetch(API,{

method:"POST",

headers:{

"Content-Type":"application/json"

},

body:JSON.stringify({

db:db,

data:data

})

});

}


/* LOAD PRODUCT */

let product=null;

async function load(){

let products=

await getDB("products");


product=

products.find(

p=>String(p.id)===String(buyId)

);


if(!product){

alert("Product Missing");

history.back();

return;

}


/* BLOCK SELF BUY */

if(product.owner===user.email){

alert("Cannot Buy Own Product");

history.back();

return;

}


cover.src=

driveImage(product.image);

title.innerText=

product.title;

price.innerText=

"â‚¹ "+product.price;

}

load();


/* FINAL PURCHASE */

async function uploadProof(){

let file=

document.getElementById("proof")

.files[0];


if(!file){

alert("Upload Screenshot");

return;

}


try{


/* UPLOAD FILE */

let form=

new FormData();

form.append("file",file);

form.append("upload","true");


let res=

await fetch(API,{

method:"POST",

body:form

});


let data=

await res.json();


let proofLink=

data.url;


/* ORDER SAVE */

let orders=

await getDB("orders")||[];


/* DUPLICATE BLOCK */

let already=

orders.find(o=>

o.buyer===user.email &&

String(o.product)===String(product.id)

);

if(already){

alert("Already Purchased");

location.href="library.html";

return;

}


orders.push({

buyer:user.email,

product:product.id,

seller:product.owner,

amount:product.price,

proof:proofLink,

review:false,

date:new Date()

.toLocaleString()

});


await saveDB(

"orders",

orders

);


/* WALLET */

let wallets=

await getDB("wallet")||[];


let sellerShare=

Math.floor(

product.price*0.8

);

let adminShare=

product.price-

sellerShare;


/* SELLER */

let seller=

wallets.find(

w=>w.email===product.owner

);

if(seller)

seller.balance+=sellerShare;

else

wallets.push({

email:product.owner,

balance:sellerShare

});


/* ADMIN */

let admin=

wallets.find(

w=>w.email===ADMIN_EMAIL

);

if(admin)

admin.balance+=adminShare;

else

wallets.push({

email:ADMIN_EMAIL,

balance:adminShare

});


await saveDB(

"wallet",

wallets

);


alert(

"Purchase Completed âœ…"

);

localStorage.removeItem(

"buyProduct"

);

location.href=

"library.html";

}catch(e){

console.log(e);

alert("Upload Failed");

}

}

</script>

</body>

</html>
